<!DOCTYPE html>
<html>
	<head>
		<link id="light_theme_stylesheet" href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
		<link id="dark_theme_stylesheet" href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css" rel="stylesheet" disabled>
		<style>
			html {
				background-color: white;
				color: black;
			}
			@media (prefers-color-scheme: dark) {
				html {
					background-color: black;
					color: white;
				}
			}
			body {
				text-align: center;
			}
			.tabulator-editable {
				background-color: orangered;
				color: white;
			}
			.max-column-value {
				background-color: lightgreen;
			}
			@media (prefers-color-scheme: dark) {
				.max-column-value {
					background-color: green;
				}
			}
		</style>
		<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
		<script>
			const prefers_color_scheme_media_query_list = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : {matches:false,addEventListener:event=>null};
			const light_theme_stylesheet = document.getElementById('light_theme_stylesheet');
			const dark_theme_stylesheet = document.getElementById('dark_theme_stylesheet');

			function changeStyleTheme(theme) {
				switch (theme) {
					case 'dark':
						light_theme_stylesheet.disabled = true;
						dark_theme_stylesheet.disabled = false;
						break;
					case 'light':
					default:
						light_theme_stylesheet.disabled = false;
						dark_theme_stylesheet.disabled = true;
						break
				}
			}

			function updateStyleTheme() {
				changeStyleTheme(prefers_color_scheme_media_query_list.matches ? 'dark' : 'light');
			}
			prefers_color_scheme_media_query_list.addEventListener('change',updateStyleTheme);
			updateStyleTheme();
		</script>
		<script>
			const ITEM_NAME_PLACEHOLDERS = 'ABCD';

			const STANDARD_STAGE_COSTS_1 = [10,10,10,10,12,12,12,12,15,15,15,15];
			const STANDARD_STAGE_COSTS_2 = [10,10,10,10,15,15,15,15,20,20,20,20];

			const STAGE_ITEMS_3_AMOUNTS_ZERO = [
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0]
			];

			const STAGE_ITEMS_3_AMOUNTS_1033 = [
				[10, 3, 3],
				[ 0,13, 3],
				[ 0, 3,13],
				[16, 0, 0],
				[16, 4, 4],
				[ 0,20, 4],
				[ 0, 4,20],
				[24, 0, 0],
				[24, 4, 4],
				[ 4,28, 0],
				[ 4, 0,28],
				[32, 0, 0]
			];

			const STAGE_ITEMS_4_AMOUNTS_ZERO = [
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0]
			];

			const STAGE_ITEMS_4_AMOUNTS_3620 = [
				[ 3, 6, 2, 0],
				[ 3, 0, 5, 2],
				[ 3, 2, 0, 5],
				[10, 1, 1, 1],
				[ 4,16, 0, 0],
				[ 4, 0,13, 0],
				[ 4, 0, 0,11],
				[14, 2, 2, 2],
				[ 5,30, 0, 0],
				[ 5, 0,24, 0],
				[ 5, 0, 0,20],
				[20, 4, 4, 4]
			];

			const EVENTS = [
				{
					id: '0',
					names: {
						'en': 'Custom'
					},
					releases: {},
					items: ['A','B','C','D'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_4_AMOUNTS_ZERO
				}, {
					id: '1J',
					names: {
						'en': 'Cherry Blossom Festival Commotion! (JP)'
					},
					releases: {'jp':'2021-02-25'},
					items: ['Event Points','Kitsune Senbei','Tanuki Okonomiyaki','Sakura Daifuku'],
					stage_costs: [20,20,20,20,20,20],
					stage_item_amounts: [
						[10,21, 0, 0],
						[10, 0,18, 0],
						[10, 0, 0,15],
						[20,42, 0, 0],
						[20, 0,36, 0],
						[20, 0, 0,30]
					]
				}, {
					id: '1G',
					names: {
						'en': 'Cherry Blossom Festival Commotion! (Global)'
					},
					releases: {'global':'2021-11-29'},
					items: ['Event Points','Kitsune Senbei','Tanuki Okonomiyaki','Sakura Daifuku'],
					stage_costs: [20,20,20,20,20,20],
					stage_item_amounts: [
						[ 5,14, 0, 0],
						[ 5, 0,12, 0],
						[ 5, 0, 0,10],
						[10,28, 0, 0],
						[10, 0,24, 0],
						[10, 0, 0,20]
					]
				}, {
					id: '1R',
					names: {
						'en': 'Cherry Blossom Festival Commotion! (Rerun)'
					},
					releases: {'jp':'2022-02-09','global':'2022-09-20'},
					items: ['Event Points','Kitsune Senbei','Tanuki Okonomiyaki','Sakura Daifuku'],
					stage_costs: [10,10,10,15,15,15],
					stage_item_amounts: [
						[10,14, 0, 0],
						[10, 0,12, 0],
						[10, 0, 0,10],
						[20,28, 0, 0],
						[20, 0,24, 0],
						[20, 0, 0,20]
					]
				}, {
					id: '2',
					names: {
						'en': 'A Revolutionary Ivan Kupala: Moustache, Pudding, and Red Winter'
					},
					releases: {'jp':'2021-04-29','global':'2022-01-11'},
					items: ['Cherino Matryoshka','Cheryonka Chocolate','Mustache Crepe'],
					stage_costs: [10,10,10,15,15,15,15],
					stage_item_amounts: [
						[15, 2, 2],
						[ 0,15, 4],
						[ 0, 4,15],
						[21, 6, 6],
						[12,21, 0],
						[12, 0,21],
						[30, 0, 0]
					]
				}, {
					id: '3',
					names: {
						'en': 'Summer Sky\'s Wishlist'
					},
					releases: {'jp':'2021-06-30','global':'2022-02-22'},
					items: ['Event Points','Beach Volleyball','Ocean House Meal Ticket','Weird Fireworks'],
					stage_costs: STANDARD_STAGE_COSTS_1,
					stage_item_amounts: STAGE_ITEMS_4_AMOUNTS_3620
				}, {
					id: '4',
					names: {
						'en': '~Prefect Team Administrator Emergency Special Order~ Head Prefect Hina\'s Summer Break'
					},
					releases: {'jp':'2021-07-29','global':'2022-03-22'},
					items: ['A Supply Chest marked with Gehenna\'s Emblem','Gourmet Research Society\'s Grilled Corn','Thug\'s Summer Sunglasses'],
					stage_costs: [10,10,10,12,12,12,15,15,15,15],
					stage_item_amounts: [
						[13, 2, 2],
						[ 0,13, 4],
						[ 0, 4,13],
						[16, 3, 3],
						[ 0,16, 6],
						[ 0, 6,16],
						[21, 6, 6],
						[12,21, 0],
						[12, 0,21],
						[30, 0, 0]
					]
				}, {
					id: '4R',
					names: {
						'en': '~Prefect Team Administrator Emergency Special Order~ Head Prefect Hina\'s Summer Break (Rerun)'
					},
					releases: {'jp':'2022-09-07','global':'2023-03-14'},
					items: ['A Supply Chest marked with Gehenna\'s Emblem','Gourmet Research Society\'s Grilled Corn','Thug\'s Summer Sunglasses'],
					stage_costs: [10,10,10,15,15,15,20,20,20,20],
					stage_item_amounts: [
						[13, 2, 2],
						[ 0,13, 4],
						[ 0, 4,13],
						[20, 4, 4],
						[ 0,20, 8],
						[ 0, 8,20],
						[28, 8, 8],
						[16,28, 0],
						[16, 0,28],
						[40, 0, 0]
					]
				}, {
					id: '5',
					names: {
						'en': 'Playing Tag at Neverland'
					},
					releases: {'jp':'2021-08-26','global':'2022-04-19'},
					items: ['Event Points','Turtle Mushroom','Black Bamboo Shoot','Ginseng Doll'],
					stage_costs: STANDARD_STAGE_COSTS_1,
					stage_item_amounts: STAGE_ITEMS_4_AMOUNTS_3620
				}, {
					id: '5R',
					names: {
						'en': 'Playing Tag at Neverland (Rerun)'
					},
					releases: {'jp':'2022-09-21','global':'2023-03-21'},
					items: ['Event Points','Turtle Mushroom','Black Bamboo Shoot','Ginseng Doll'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: [
						[ 3, 6, 2, 0],
						[ 3, 0, 5, 2],
						[ 3, 2, 0, 5],
						[10, 1, 1, 1],
						[ 5,20, 0, 0],
						[ 5, 0,16, 0],
						[ 5, 0, 0,14],
						[18, 3, 3, 3],
						[ 7,40, 0, 0],
						[ 7, 0,32, 0],
						[ 7, 0, 0,27],
						[27, 5, 5, 5]
					]
				}, {
					id: '6',
					names: {
						'en': 'Bunny Chasers on Board'
					},
					releases: {'jp':'2021-09-29','global':'2022-05-03'},
					items: ['Chocolate Coin','Rabbit Sticker','Boarding Ticket'],
					stage_costs: [10,10,10,12,12,12,15,15,15],
					stage_item_amounts: [
						[ 0,13, 4],
						[ 0, 4,13],
						[13, 2, 2],
						[ 0,16, 6],
						[ 0, 6,16],
						[16, 3, 3],
						[12,21, 0],
						[12, 0,21],
						[30, 0, 0]
					]
				}, {
					id: '7',
					names: {
						'en': 'Hatsune Miku Special Live In Kivotos ~ Rehearsal'
					},
					releases: {'jp':'2021-11-03','global':'2022-06-14'},
					items: [],
					stage_costs: [],
					stage_item_amounts: []
				}, {
					id: '8',
					names: {
						'en': 'Hot Springs Resort No. 227 Daily Logs! Warmth in a Snowy Landscape'
					},
					releases: {'jp':'2021-11-30','global':'2022-07-12'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '9',
					names: {
						'en': 'New Year\'s Rhapsody No. 68'
					},
					releases: {'jp':'2021-12-29','global':'2022-08-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '10',
					names: {
						'en': 'Schale\'s Happy Valentine Patrol & Kosaka Wakamo\'s Silence and Feast'
					},
					releases: {'jp':'2022-01-26','global':'2022-09-06'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '11',
					names: {
						'en': 'The Clumsy Sister and the Magician of the Old Library'
					},
					releases: {'jp':'2022-02-23','global':'2022-10-04'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '12',
					names: {
						'en': 'An Unconcealed Heart'
					},
					releases: {'jp':'2022-04-27','global':'2022-11-29'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '13',
					names: {
						'en': 'Abydos Resort Restoration Task Force'
					},
					releases: {'jp':'2022-06-22','global':'2023-01-17'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '14',
					names: {
						'en': 'Biz Trip! Momoyodou Beach Shack Franchise Plan'
					},
					releases: {'jp':'2022-07-20','global':'2023-01-31'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '15',
					names: {
						'en': 'After-School Sweets Story: Sweet, Secrets, and Shootouts'
					},
					releases: {'jp':'2022-08-24','global':'2023-02-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '16',
					names: {
						'en': 'On Your Mark @ Millennium ~ Kivotos Halo Festival'
					},
					releases: {'jp':'2022-09-28','global':'2023-03-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '17',
					names: {
						'en': 'Get Set, Go! Kivotos Halo Festival'
					},
					releases: {'jp':'2022-10-26','global':'2023-04-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '18',
					names: {
						'en': 'The Cathedral\'s Merry Christmas: Remedial Knights\' Gift'
					},
					releases: {'jp':'2022-12-14','global':'2023-06-13'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '19',
					names: {
						'en': 'New Year\'s Aperitif: One-and-Done Match'
					},
					releases: {'jp':'2022-12-28','global':'2023-06-27'},
					items: ['Event Points','Red & White Fish Cakes','Snapper'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '20',
					names: {
						'en': 'Restoration Project: D.U. Shiratori City'
					},
					releases: {'jp':'2023-03-12','global':'2023-09-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '21',
					names: {
						'en': 'Alabaster Calling Card: Mansion Masquerade and the Essence of Beauty'
					},
					releases: {'jp':'2023-04-26','global':'2023-10-31'},
					items: ['Immaculate Maid Hairband','Makeup Palette','Old Mansion Invitation'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '22',
					names: {
						'en': 'Dragon & Tortoise, Working Together for a Better Future'
					},
					releases: {'jp':'2023-05-24','global':'2023-11-28'},
					items: ['Card Bundle','Meal Ticket','Genryumon Badge'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '23',
					names: {
						'en': 'Special Summer Mission! RABBIT Squad and the Mystery of the Missing Shrimp'
					},
					releases: {'jp':'2023-06-21','global':'2023-12-26'},
					items: ['Frozen Shrimp','Pebble','Seashell','Dried Starfish'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_4_AMOUNTS_ZERO
				}, {
					id: '24',
					names: {
						'en': 'Trinity Extracurriculars: In Search of Hidden Ruins'
					},
					releases: {'jp':'2023-07-24','global':'2024-01-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '25',
					names: {
						'en': 'Academy Club Story: A Pair\'s Final Adventure'
					},
					releases: {'jp':'2023-08-23','global':'2024-02-27'},
					items: ['Tarot del Luna','Ink Cartridge','Tablet Pen'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_1033
				}, {
					id: '25R',
					names: {
						'en': 'Academy Club Story: A Pair\'s Final Adventure (Rerun)'
					},
					releases: {'jp':'2024-08-07','global':'2025-02-08'},
					items: ['Tarot del Luna','Ink Cartridge','Tablet Pen'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_1033
				}, {
					id: '26',
					names: {
						'en': 'Trip-Trap-Train'
					},
					releases: {'jp':'2023-09-27','global':'2024-04-02'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '27',
					names: {
						'en': 'A Certain Scientific Record of Youth'
					},
					releases: {'jp':'2023-10-24','global':'2024-04-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '28',
					names: {
						'en': 'Cyber New Year March'
					},
					releases: {'jp':'2023-12-27','global':'2024-06-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '29',
					names: {
						'en': 'Basking in the Brilliance of Their Serenade'
					},
					releases: {'jp':'2024-01-24','global':'2024-07-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '30',
					names: {
						'en': '0068 From Opera with Love!'
					},
					releases: {'jp':'2024-02-21','global':'2024-08-20'},
					items: ['Target Clue','Concert Program','Bow Tie'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '31',
					names: {
						'en': 'Rowdy and Cheery'
					},
					releases: {'jp':'2024-03-27','global':'2024-09-24'},
					items: ['Hyakkiyako Commemorative Card','Field Trip Itenerary','Guide Flag'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_1033
				}, {
					id: '32',
					names: {
						'en': '-ive aLIVE!'
					},
					releases: {'jp':'2024-04-24','global':'2024-10-22'},
					items: ['D-Day Calendar','Recharge Cookie','Motivation Boost Candy'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '33',
					names: {
						'en': 'Say-Bing!'
					},
					releases: {'jp':'2024-06-26','global':'2024-12-24'},
					items: ['Water Park Wristband','Safety Whistle','Lifebuoy'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '34',
					names: {
						'en': 'Sheside Outside'
					},
					releases: {'jp':'2024-07-22','global':'2025-01-23'},
					items: ['Game Booth Voucher','Helmet Gangster Grand Alliance Coin','Food Stall Menu'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '35',
					names: {
						'en': 'Radiant Moon, Raucous Dream'
					},
					releases: {'jp':'2024-08-21','global':'2025-02-18'},
					items: ['Souvenir Doll','Mini Tea Set','Rikkagaku Model'],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: [
						[ 8, 5, 5],
						[ 5, 8, 5],
						[ 5, 5, 8],
						[12, 3, 3],
						[15, 6, 6],
						[ 6,15, 6],
						[ 6, 6,15],
						[23, 2, 2],
						[28, 4, 4],
						[ 4,32, 0],
						[ 4, 0,32],
						[36, 0, 0]
					]
				}, {
					id: '36',
					names: {
						'en': 'Descent of the Five Senses'
					},
					releases: {'jp':'2024-09-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '37',
					names: {
						'en': 'Serenade Promenade'
					},
					releases: {'jp':'2024-10-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '38',
					names: {
						'en': 'Secret Midnight Party ~ Oni Holds a Bell ~'
					},
					releases: {'jp':'2024-12-24'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					id: '39',
					names: {
						'en': 'Code: BOX Shadow Approaching the Millennium ~ One Question and Two Answers ~'
					},
					releases: {'jp':'2025-01-20'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS_2,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}
			];

			const dummyStorage = {
				storage: {},
				getItem: function(key) {
					return this.storage[key];
				},
				setItem: function(key,value) {
					this.storage[key] = value;
				},
				removeItem: function(key) {
					delete this.storage[key];
				}
			}
			const storage = {
				storage: (() => {
					try {
						return window.localStorage || window.sessionStorage || dummyStorage;
					} catch (e) {
						try {
							return window.sessionStorage || dummyStorage;
						} catch (e) {
							return dummyStorage;
						}
					}
				})(),
				get: function(event_id) {
					return JSON.parse(this.storage.getItem('EVENT_'+event_id));
				},
				set: function(event_id,data) {
					if (data.every(row => row.every(value => value === 0))) {
						this.storage.removeItem('EVENT_'+event_id);
					} else {
						this.storage.setItem('EVENT_'+event_id,JSON.stringify(data));
					}
				}
			};

			function loadEventData(event_id) {
				const data = EVENTS.find(e => e.id === event_id);

				if (data) {
					console.log('Loading data for event "' + data.names['en'] + '".');
				} else {
					console.error('No event data was given.');
					return false;
				}

				const num_stages = data.stage_costs.length;

				if (num_stages !== data.stage_item_amounts.length) {
					console.error('The amount of data for this event does not match.\nStage Costs:', num_stages, '\nStage Items:', data.stage_item_amounts.length);
					return false;
				}

				const num_stage_items = data.items.length;

				if (!data.stage_item_amounts.every(amounts => amounts.length === num_stage_items)) {
					console.error('This stage has ' + num_stage_items + ' items, but the amount of item amounts does not match.');
					return false;
				}

				const stored_bonus_multiplier_data = storage.get(event_id);
				const event_table_data = data.stage_costs.map((ap_cost,stage_index) => {
					const stage_item_amounts = data.stage_item_amounts[stage_index];
					const row_data = {
						stage: stage_index+1,
						ap_cost: ap_cost
					};
					for (let i = 0; i < stage_item_amounts.length; ++i) {
						row_data['item_amount_'+i] = stage_item_amounts[i];
					}
					if (stored_bonus_multiplier_data) {
						const stored_bonus_multiplier_row_data = stored_bonus_multiplier_data[stage_index];
						for (let i = 0; i < num_stage_items; ++i) {
							row_data['bonus_multiplier_'+i] = stored_bonus_multiplier_row_data[i];
						}
					} else {
						for (let i = 0; i < num_stage_items; ++i) {
							row_data['bonus_multiplier_'+i] = 0;
						}
					}
					return row_data;
				});

				const event_data_title = document.getElementById('event_data_title');
				event_data_title.innerText = data.names['en'];
				const event_data_subtitle = document.getElementById('event_data_subtitle');
				event_data_subtitle.innerText = data.items.map((item,index) => item + ' = ' + ITEM_NAME_PLACEHOLDERS[index]).join(', ');

				const event_data_table = document.getElementById('event_data');
				function totalPerAPFormatter(cell,params) {
					const col_cells = cell.getColumn().getCells();
					// The table loads row-by-row, so we have to wait for all rows to be loaded.
					// Once all rows have been loaded we then need to set the style for every cell in this column.
					if (col_cells.length === num_stages) {
						const col_data = col_cells.map(c => [c.getValue(),c.getElement()]);
						const max_value = col_data.reduce((max,curr_data) => Math.max(max,curr_data[0]), 0);
						for (let cell_data of col_data) {
							cell_data[1].classList.toggle('max-column-value', cell_data[0] === max_value);
						}
					}
					return cell.getValue().toFixed(2);
				}
				const table = new Tabulator(event_data_table, {
					columns: [
						{ field: 'stage', title: 'Stage', headerSort: true },
						{ field: 'ap_cost', title: 'AP Cost' },
						...data.items.map((item,index) => { return {
							field: 'item_amount_' + index,
							title: 'Item '+ITEM_NAME_PLACEHOLDERS[index],
							editor: event_id === '0' ? 'number' : false,
							editorEmptyValue: 0,
							editorParams: { min: 0, selectContents: true },
							mutateLink: data.items.flatMap((item,index) => ['bonus_amount_'+index,'total_'+index])
						}; }),
						...data.items.map((item,index) => { return {
							field: 'bonus_multiplier_' + index,
							title: 'Bonus % ' + ITEM_NAME_PLACEHOLDERS[index],
							editor: 'number',
							editorEmptyValue: 0,
							editorParams: { min: 0, step: 5, max: 100, selectContents: true },
							formatter: 'money',
							formatterParams: { symbol: '%', symbolAfter: true, precision: 0 },
							mutateLink: data.items.map((item,index) => 'bonus_amount_'+index)
						}; }),
						...data.items.map((item,index) => { return {
							field: 'bonus_amount_' + index,
							title: 'Bonus ' + ITEM_NAME_PLACEHOLDERS[index],
							mutator: (value,data) => Math.ceil(data['item_amount_'+index] * data['bonus_multiplier_'+index] / 100),
							mutateLink: data.items.map((item,index) => 'total_'+index)
						}; }),
						...data.items.map((item,index) => { return {
							field: 'total_' + index,
							title: 'Total ' + ITEM_NAME_PLACEHOLDERS[index],
							mutator: (value,data) => data['item_amount_'+index] + data['bonus_amount_'+index],
							mutateLink: ['sum', ...data.items.map((item,index) => 'total_per_ap_'+index)]
						}; }),
						{
							field: 'sum',
							title: 'Sum',
							mutator: (value,data) => {
								let sum = 0;
								for (let i = 0; i < num_stage_items; ++i) {
									sum += data['total_'+i];
								}
								return sum;
							},
							mutateLink: 'total_sum_per_ap'
						},
						...data.items.map((item,index) => { return {
							field: 'total_per_ap_' + index,
							title: 'Total '+ITEM_NAME_PLACEHOLDERS[index] + ' / AP',
							formatter: totalPerAPFormatter,
							mutator: (value,data) => data['total_'+index] / data['ap_cost'],
							headerSort: true
						}; }),
						{
							field: 'total_sum_per_ap',
							title: 'Total / AP',
							formatter: totalPerAPFormatter,
							mutator: (value,data) => data['sum'] / data['ap_cost'],
							headerSort: true
						}
					],
					columnDefaults: {headerSort:false,resizable:false},
					data: event_table_data,
					index: 'stage',
					layout: 'fitDataTable'
				});

				table.on('tableBuilt', event => document.body.children[1].scrollIntoView());
				table.on('cellEdited', cell => {
					const field_name = cell.getField();
					if (field_name.startsWith('bonus_multiplier_')) {
						const data = storage.get(event_id) || Array(num_stages).fill(0).map(() => Array(num_stage_items).fill(0));
						const row = cell.getRow().getIndex() - 1;
						const col = parseInt(field_name.split('_').slice(-1)[0],10);
						data[row][col] = cell.getValue();
						storage.set(event_id,data);
					}
				});

				return true;
			}

			document.addEventListener('DOMContentLoaded', event => {
				function stringCompare(a,b) {
					return a < b ? -1 : (a > b ? 1 : 0);
				}
				function eventSorter(a, b, aRow, bRow, column, dir, sorterParams) {
					const a_date_jp = aRow.getCell('releases.jp').getValue();
					const a_date_global = aRow.getCell('releases.global').getValue();
					const b_date_jp = bRow.getCell('releases.jp').getValue();
					const b_date_global = bRow.getCell('releases.global').getValue();
					let ret;
					if (a_date_jp && b_date_jp) {
						ret = stringCompare(a_date_jp,b_date_jp);
					} else if (a_date_global && b_date_global) {
						ret = stringCompare(a_date_global,b_date_global);
					} else if ((a_date_jp || a_date_global) && (b_date_jp || b_date_global)) {
						ret = stringCompare(a_date_jp || a_date_global, b_date_jp || b_date_global);
					} else if (a_date_jp || a_date_global) {
						ret = 1;
					} else if (b_date_jp || b_date_global) {
						ret = -1;
					} else {
						ret = stringCompare(aRow.getIndex(),bRow.getIndex());
					}
					return ret;
				}
				const table = new Tabulator('#events', {
					columns: [
						{ field: 'id', visible: false },
						{ field: 'names.en', title: 'Name' },
						{ field: 'releases.jp', title: 'JP Release Date', sorter: eventSorter },
						{ field: 'releases.global', title: 'Global Release Date', sorter: eventSorter }
					],
					columnDefaults: {resizable:false},
					data: EVENTS.filter(e => e.items.length > 0),
					initialSort: [{column:'releases.jp',dir:'desc'}],
					layout: 'fitDataTable'
				});
				table.on('rowClick', (e,row) => {
					try {
						loadEventData(row.getIndex());
					} catch (error) {
						console.error(error);
					}
				});
			});
		</script>
	</head>
	<body>
		<section>
			<h2>Events</h2>
			<div id="events"></div>
		</section>
		<section>
			<h2 id="event_data_title"></h2>
			<p id="event_data_subtitle"></p>
			<div id="event_data"></div>
		</section>
	</body>
</html>
