<!DOCTYPE html>
<html>
	<head>
		<link id="light_theme_stylesheet" href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
		<link id="dark_theme_stylesheet" href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css" rel="stylesheet" disabled>
		<style>
			html {
				background-color: white;
				color: black;
			}
			@media (prefers-color-scheme: dark) {
				html {
					background-color: black;
					color: white;
				}
			}
			body {
				text-align: center;
			}
			.max-column-value {
				background-color: lightgreen;
			}
			@media (prefers-color-scheme: dark) {
				.max-column-value {
					background-color: green;
				}
			}
		</style>
		<script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
		<script>
			const prefers_color_scheme_media_query_list = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : {matches:false,addEventListener:event=>null};
			const light_theme_stylesheet = document.getElementById('light_theme_stylesheet');
			const dark_theme_stylesheet = document.getElementById('dark_theme_stylesheet');

			function changeStyleTheme(theme) {
				switch (theme) {
					case 'dark':
						light_theme_stylesheet.disabled = true;
						dark_theme_stylesheet.disabled = false;
						break;
					case 'light':
					default:
						light_theme_stylesheet.disabled = false;
						dark_theme_stylesheet.disabled = true;
						break
				}
			}

			function updateStyleTheme() {
				changeStyleTheme(prefers_color_scheme_media_query_list.matches ? 'dark' : 'light');
			}
			prefers_color_scheme_media_query_list.addEventListener('change',updateStyleTheme);
			updateStyleTheme();
		</script>
		<script>
			const ITEM_NAME_PLACEHOLDERS = 'ABCD';
			const STANDARD_STAGE_COSTS = [10,10,10,10,15,15,15,15,20,20,20,20];

			const STAGE_ITEMS_3_AMOUNTS_ZERO = [
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0],
				[0,0,0]
			];

			const STAGE_ITEMS_4_AMOUNTS_ZERO = [
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0],
				[0,0,0,0]
			];

			const STAGE_ITEMS_3_AMOUNTS_1 = [
				[10,3,3],
				[0,13,3],
				[0,3,13],
				[16,0,0],
				[16,4,4],
				[0,20,4],
				[0,4,20],
				[24,0,0],
				[24,4,4],
				[4,28,0],
				[4,0,28],
				[32,0,0]
			];

			const EVENTS = [
				{
					names: {
						'en': 'Cherry Blossom Festival Commotion!'
					},
					releases: {'jp':'2021-02-25','global':'2021-11-29'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'A Revolutionary Ivan Kupala: Moustache, Pudding, and Red Winter'
					},
					releases: {'jp':'2021-04-29','global':'2022-01-11'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Summer Sky\'s Wishlist'
					},
					releases: {'jp':'2021-06-30','global':'2022-02-22'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': '~Prefect Team Administrator Emergency Special Order~ Head Prefect Hina\'s Summer Break'
					},
					releases: {'jp':'2021-07-29','global':'2022-03-22'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Playing Tag at Neverland'
					},
					releases: {'jp':'2021-08-26','global':'2022-04-19'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Bunny Chasers on Board'
					},
					releases: {'jp':'2021-09-29','global':'2022-05-03'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Hatsune Miku Special Live In Kivotos ~ Rehearsal'
					},
					releases: {'jp':'2021-11-03','global':'2022-06-14'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Hot Springs Resort No. 227 Daily Logs! Warmth in a Snowy Landscape'
					},
					releases: {'jp':'2021-11-30','global':'2022-07-12'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'New Year\'s Rhapsody No. 68'
					},
					releases: {'jp':'2021-12-29','global':'2022-08-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Schale\'s Happy Valentine Patrol & Kosaka Wakamo\'s Silence and Feast'
					},
					releases: {'jp':'2022-01-26','global':'2022-09-06'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'The Clumsy Sister and the Magician of the Old Library'
					},
					releases: {'jp':'2022-02-23','global':'2022-10-04'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'An Unconcealed Heart'
					},
					releases: {'jp':'2022-04-27','global':'2022-11-29'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Abydos Resort Restoration Task Force'
					},
					releases: {'jp':'2022-06-22','global':'2023-01-17'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Biz Trip! Momoyodou Beach Shack Franchise Plan'
					},
					releases: {'jp':'2022-07-20','global':'2023-01-31'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'After-School Sweets Story: Sweet, Secrets, and Shootouts'
					},
					releases: {'jp':'2022-08-24','global':'2023-02-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'On Your Mark @ Millennium ~ Kivotos Halo Festival'
					},
					releases: {'jp':'2022-09-28','global':'2023-03-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Get Set, Go! Kivotos Halo Festival'
					},
					releases: {'jp':'2022-10-26','global':'2023-04-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'The Cathedral\'s Merry Christmas: Remedial Knights\' Gift'
					},
					releases: {'jp':'2022-12-14','global':'2023-06-13'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'New Year\'s Aperitif: One-and-Done Match'
					},
					releases: {'jp':'2022-12-28','global':'2023-06-27'},
					items: ['Event Points','Red & White Fish Cakes','Snapper'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Restoration Project: D.U. Shiratori City'
					},
					releases: {'jp':'2023-03-12','global':'2023-09-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Alabaster Calling Card: Mansion Masquerade and the Essence of Beauty'
					},
					releases: {'jp':'2023-04-26','global':'2023-10-31'},
					items: ['Immaculate Maid Hairband','Makeup Palette','Old Mansion Invitation'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Dragon & Tortoise, Working Together for a Better Future'
					},
					releases: {'jp':'2023-05-24','global':'2023-11-28'},
					items: ['Card Bundle','Meal Ticket','Genryumon Badge'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Special Summer Mission! RABBIT Squad and the Mystery of the Missing Shrimp'
					},
					releases: {'jp':'2023-06-21','global':'2023-12-26'},
					items: ['Frozen Shrimp','Pebble','Seashell','Dried Starfish'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_4_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Trinity Extracurriculars: In Search of Hidden Ruins'
					},
					releases: {'jp':'2023-07-24','global':'2024-01-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Academy Club Story: A Pair\'s Final Adventure'
					},
					releases: {'jp':'2023-08-23','global':'2024-02-27'},
					items: ['Tarot del Luna','Ink Cartridge','Tablet Pen'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_1
				}, {
					names: {
						'en': 'Trip-Trap-Train'
					},
					releases: {'jp':'2023-09-27','global':'2024-04-02'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'A Certain Scientific Record of Youth'
					},
					releases: {'jp':'2023-10-24','global':'2024-04-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Cyber New Year March'
					},
					releases: {'jp':'2023-12-27','global':'2024-06-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Basking in the Brilliance of Their Serenade'
					},
					releases: {'jp':'2024-01-24','global':'2024-07-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': '0068 From Opera with Love!'
					},
					releases: {'jp':'2024-02-21','global':'2024-08-20'},
					items: ['Target Clue','Concert Program','Bow Tie'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Rowdy and Cheery'
					},
					releases: {'jp':'2024-03-27','global':'2024-09-24'},
					items: ['Hyakkiyako Commemorative Card','Field Trip Itenerary','Guide Flag'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_1
				}, {
					names: {
						'en': '-ive aLIVE!'
					},
					releases: {'jp':'2024-04-24','global':'2024-10-22'},
					items: ['D-Day Calendar','Recharge Cookie','Motivation Boost Candy'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Say-Bing!'
					},
					releases: {'jp':'2024-06-26','global':'2024-12-24'},
					items: ['Water Park Wristband','Safety Whistle','Lifebuoy'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Sheside Outside'
					},
					releases: {'jp':'2024-07-22','global':'2025-01-23'},
					items: ['Game Booth Voucher','Helmet Gangster Grand Alliance Coin','Food Stall Menu'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Radiant Moon, Raucous Dream'
					},
					releases: {'jp':'2024-08-21','global':'2025-02-18'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Descent of the Five Senses'
					},
					releases: {'jp':'2024-09-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Serenade Promenade'
					},
					releases: {'jp':'2024-10-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Secret Midnight Party ~ Oni Holds a Bell ~'
					},
					releases: {'jp':'2024-12-24'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}, {
					names: {
						'en': 'Code: BOX Shadow Approaching the Millennium ~ One Question and Two Answers ~'
					},
					releases: {'jp':'2025-01-20'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEMS_3_AMOUNTS_ZERO
				}
			];

			function loadEventData(index) {
				const data = EVENTS[index];

				if (data) {
					console.log('Loading data for event "' + data.names['en'] + '".');
				} else {
					console.error('Event index ' + index + ' is not valid.');
					return false;
				}

				if (data.stage_costs.length !== data.stage_item_amounts.length) {
					console.error('The amount of data for this event does not match.\nStage Costs:', data.stage_costs.length, '\nStage Items:', data.stage_item_amounts.length);
					return false;
				}

				const num_stage_items = data.items.length;

				if (!data.stage_item_amounts.every(amounts => amounts.length === num_stage_items)) {
					console.error('This stage has ' + num_stage_items + ' items, but the amount of item amounts does not match.');
					return false;
				}

				const event_table_data = data.stage_costs.map((ap_cost,stage_index) => {
					const stage_item_amounts = data.stage_item_amounts[stage_index];
					const row_data = {
						stage: stage_index+1,
						ap_cost: ap_cost
					};
					for (let i = 0; i < stage_item_amounts.length; ++i) {
						row_data['item_amount_'+i] = stage_item_amounts[i];
					}
					// TODO reload saved bonus multipliers
					for (let i = 0; i < num_stage_items; ++i) {
						row_data['bonus_multiplier_'+i] = 0;
					}
					return row_data;
				});

				const event_data_title = document.getElementById('event_data_title');
				event_data_title.innerText = data.names['en'];
				const event_data_subtitle = document.getElementById('event_data_subtitle');
				event_data_subtitle.innerText = data.items.map((item,index) => item + ' = ' + ITEM_NAME_PLACEHOLDERS[index]).join(', ');

				const event_data_table = document.getElementById('event_data');
				function totalPerAPFormatter(cell,params) {
					const col_cells = cell.getColumn().getCells();
					// The table loads row-by-row, so we have to wait for all rows to be loaded.
					// Once all rows have been loaded we then need to set the style for every cell in this column.
					if (col_cells.length === data.stage_costs.length) {
						const col_data = col_cells.map(c => [c.getValue(),c.getElement()]);
						const max_value = col_data.reduce((max,curr_data) => Math.max(max,curr_data[0]), 0);
						for (let cell_data of col_data) {
							cell_data[1].classList.toggle('max-column-value', cell_data[0] === max_value);
						}
					}
					return cell.getValue().toFixed(2);
				}
				const table = new Tabulator(event_data_table, {
					columns: [
						{ field: 'stage', title: 'Stage' },
						{ field: 'ap_cost', title: 'AP Cost' },
						...data.items.map((item,index) => { return {field: 'item_amount_'+index, title: 'Item '+ITEM_NAME_PLACEHOLDERS[index]}; }),
						...data.items.map((item,index) => { return {
							field: 'bonus_multiplier_' + index,
							title: 'Multiplier ' + ITEM_NAME_PLACEHOLDERS[index],
							editor: 'number',
							editorParams: { min: 0, step: 5, max: 100, selectContents: true },
							formatter: 'money',
							formatterParams: { symbol: '%', symbolAfter: true, precision: 0 },
							mutateLink: data.items.map((item,index) => 'bonus_amount_'+index)
						}; }),
						...data.items.map((item,index) => { return {
							field: 'bonus_amount_' + index,
							title: 'Bonus ' + ITEM_NAME_PLACEHOLDERS[index],
							mutator: (value,data) => Math.ceil(data['item_amount_'+index] * data['bonus_multiplier_'+index] / 100),
							mutateLink: data.items.map((item,index) => 'total_'+index)
						}; }),
						...data.items.map((item,index) => { return {
							field: 'total_' + index,
							title: 'Total ' + ITEM_NAME_PLACEHOLDERS[index],
							mutator: (value,data) => data['item_amount_'+index] + data['bonus_amount_'+index],
							mutateLink: ['sum', ...data.items.map((item,index) => 'total_per_ap_'+index)]
						}; }),
						{
							field: 'sum',
							title: 'Sum',
							mutator: (value,data) => {
								let sum = 0;
								for (let i = 0; i < num_stage_items; ++i) {
									sum += data['total_'+i];
								}
								return sum;
							},
							mutateLink: 'total_sum_per_ap'
						},
						...data.items.map((item,index) => { return {
							field: 'total_per_ap_' + index,
							title: 'Total '+ITEM_NAME_PLACEHOLDERS[index] + ' / AP',
							formatter: totalPerAPFormatter,
							mutator: (value,data) => data['total_'+index] / data['ap_cost']
						}; }),
						{
							field: 'total_sum_per_ap',
							title: 'Total / AP',
							formatter: totalPerAPFormatter,
							mutator: (value,data) => data['sum'] / data['ap_cost']
						}
					],
					columnDefaults: {resizable:false},
					data: event_table_data,
					layout: 'fitDataTable'
				});

				table.on('tableBuilt', event => document.body.children[1].scrollIntoView());

				return true;
			}

			document.addEventListener('DOMContentLoaded', event => {
				const events_table_data = EVENTS.map((e,i) => {
					return {
						'id': i,
						'Name': e.names['en'],
						'JP Release Date': e.releases['jp'],
						'Global Release Date': e.releases['global']
					};
				});
				const table = new Tabulator('#events', {
					autoColumns: true,
					autoColumnsDefinitions: [{field:'id',visible:false}],
					columnDefaults: {resizable:false},
					data: events_table_data,
					initialSort: [{column:'JP Release Date',dir:'desc'}],
					layout: 'fitDataTable'
				});
				table.on('rowClick', (e,row) => {
					try {
						loadEventData(row.getIndex());
					} catch (error) {
						console.error(error);
					}
				});
			});
		</script>
	</head>
	<body>
		<section>
			<h2>Events</h2>
			<table id="events"></table>
		</section>
		<section>
			<h2 id="event_data_title"></h2>
			<p id="event_data_subtitle"></p>
			<table id="event_data"></table>
		</section>
	</body>
</html>
