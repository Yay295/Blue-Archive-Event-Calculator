<!DOCTYPE html>
<html>
	<head>
		<link href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css" rel="stylesheet">
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js"></script>
		<script>
			const ITEM_NAME_PLACEHOLDERS = 'ABCD';
			const STANDARD_STAGE_COSTS = [10,10,10,10,15,15,15,15,20,20,20,20];

			const STAGE_ITEM_AMOUNTS_1 = [
				[10,3,3],
				[0,13,3],
				[0,3,13],
				[16,0,0],
				[16,4,4],
				[0,20,4],
				[0,4,20],
				[24,0,0],
				[24,4,4],
				[4,28,0],
				[4,0,28],
				[32,0,0]
			];

			const EVENTS = [
				{
					names: {
						'en': 'Cherry Blossom Festival Commotion!'
					},
					releases: {'jp':'2021-02-25','global':'2021-11-29'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'A Revolutionary Ivan Kupala: Moustache, Pudding, and Red Winter'
					},
					releases: {'jp':'2021-04-29','global':'2022-01-11'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Summer Sky\'s Wishlist'
					},
					releases: {'jp':'2021-06-30','global':'2022-02-22'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': '~Prefect Team Administrator Emergency Special Order~ Head Prefect Hina\'s Summer Break'
					},
					releases: {'jp':'2021-07-29','global':'2022-03-22'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Playing Tag at Neverland'
					},
					releases: {'jp':'2021-08-26','global':'2022-04-19'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Bunny Chasers on Board'
					},
					releases: {'jp':'2021-09-29','global':'2022-05-03'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Hatsune Miku Special Live In Kivotos ~ Rehearsal'
					},
					releases: {'jp':'2021-11-03','global':'2022-06-14'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Hot Springs Resort No. 227 Daily Logs! Warmth in a Snowy Landscape'
					},
					releases: {'jp':'2021-11-30','global':'2022-07-12'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'New Year\'s Rhapsody No. 68'
					},
					releases: {'jp':'2021-12-29','global':'2022-08-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Schale\'s Happy Valentine Patrol & Kosaka Wakamo\'s Silence and Feast'
					},
					releases: {'jp':'2022-01-26','global':'2022-09-06'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'The Clumsy Sister and the Magician of the Old Library'
					},
					releases: {'jp':'2022-02-23','global':'2022-10-04'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'An Unconcealed Heart'
					},
					releases: {'jp':'2022-04-27','global':'2022-11-29'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Abydos Resort Restoration Task Force'
					},
					releases: {'jp':'2022-06-22','global':'2023-01-17'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Biz Trip! Momoyodou Beach Shack Franchise Plan'
					},
					releases: {'jp':'2022-07-20','global':'2023-01-31'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'After-School Sweets Story: Sweet, Secrets, and Shootouts'
					},
					releases: {'jp':'2022-08-24','global':'2023-02-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'On Your Mark @ Millennium ~ Kivotos Halo Festival'
					},
					releases: {'jp':'2022-09-28','global':'2023-03-28'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Get Set, Go! Kivotos Halo Festival'
					},
					releases: {'jp':'2022-10-26','global':'2023-04-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'The Cathedral\'s Merry Christmas: Remedial Knights\' Gift'
					},
					releases: {'jp':'2022-12-14','global':'2023-06-13'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'New Year\'s Aperitif: One-and-Done Match'
					},
					releases: {'jp':'2022-12-28','global':'2023-06-27'},
					items: ['Event Points','Red & White Fish Cakes','Snapper'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Restoration Project: D.U. Shiratori City'
					},
					releases: {'jp':'2023-03-12','global':'2023-09-09'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Alabaster Calling Card: Mansion Masquerade and the Essence of Beauty'
					},
					releases: {'jp':'2023-04-26','global':'2023-10-31'},
					items: ['Immaculate Maid Hairband','Makeup Palette','Old Mansion Invitation'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Dragon & Tortoise, Working Together for a Better Future'
					},
					releases: {'jp':'2023-05-24','global':'2023-11-28'},
					items: ['Card Bundle','Meal Ticket','Genryumon Badge'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Special Summer Mission! RABBIT Squad and the Mystery of the Missing Shrimp'
					},
					releases: {'jp':'2023-06-21','global':'2023-12-26'},
					items: ['Frozen Shrimp','Pebble','Seashell','Dried Starfish'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Trinity Extracurriculars: In Search of Hidden Ruins'
					},
					releases: {'jp':'2023-07-24','global':'2024-01-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Academy Club Story: A Pair\'s Final Adventure'
					},
					releases: {'jp':'2023-08-23','global':'2024-02-27'},
					items: ['Tarot del Luna','Ink Cartridge','Tablet Pen'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEM_AMOUNTS_1
				}, {
					names: {
						'en': 'Trip-Trap-Train'
					},
					releases: {'jp':'2023-09-27','global':'2024-04-02'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'A Certain Scientific Record of Youth'
					},
					releases: {'jp':'2023-10-24','global':'2024-04-30'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Cyber New Year March'
					},
					releases: {'jp':'2023-12-27','global':'2024-06-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Basking in the Brilliance of Their Serenade'
					},
					releases: {'jp':'2024-01-24','global':'2024-07-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': '0068 From Opera with Love!'
					},
					releases: {'jp':'2024-02-21','global':'2024-08-20'},
					items: ['Target Clue','Concert Program','Bow Tie'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Rowdy and Cheery'
					},
					releases: {'jp':'2024-03-27','global':'2024-09-24'},
					items: ['Hyakkiyako Commemorative Card','Field Trip Itenerary','Guide Flag'],
					stage_costs: STANDARD_STAGE_COSTS,
					stage_item_amounts: STAGE_ITEM_AMOUNTS_1
				}, {
					names: {
						'en': '-ive aLIVE!'
					},
					releases: {'jp':'2024-04-24','global':'2024-10-22'},
					items: ['D-Day Calendar','Recharge Cookie','Motivation Boost Candy'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Say-Bing!'
					},
					releases: {'jp':'2024-06-26','global':'2024-12-24'},
					items: ['Water Park Wristband','Safety Whistle','Lifebuoy'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Sheside Outside'
					},
					releases: {'jp':'2024-07-22','global':'2025-01-23'},
					items: ['Game Booth Voucher','Helmet Gangster Grand Alliance Coin','Food Stall Menu'],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Radiant Moon, Raucous Dream'
					},
					releases: {'jp':'2024-08-21','global':'2025-02-18'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Descent of the Five Senses'
					},
					releases: {'jp':'2024-09-25'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Serenade Promenade'
					},
					releases: {'jp':'2024-10-23'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Secret Midnight Party ~ Oni Holds a Bell ~'
					},
					releases: {'jp':'2024-12-24'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}, {
					names: {
						'en': 'Code: BOX Shadow Approaching the Millennium ~ One Question and Two Answers ~'
					},
					releases: {'jp':'2025-01-20'},
					items: [],
					stage_costs: STANDARD_STAGE_COSTS
				}
			];

			function loadEventData(index) {
				const data = EVENTS[index];

				if (data) {
					console.log('Loading data for event "' + data.names['en'] + '".');
				} else {
					console.error('Event index ' + index + ' is not valid.');
					return false;
				}

				if (data.stage_costs.length !== data.stage_item_amounts.length) {
					console.error('The amount of data for this event does not match.\nStage Costs:', data.stage_costs.length, '\nStage Items:', data.stage_item_amounts.length);
					return false;
				}

				const num_stage_items = data.items.length;

				if (!data.stage_item_amounts.every(amounts => amounts.length === num_stage_items)) {
					console.error('This stage has ' + num_stage_items + ' items, but the amount of item amounts does not match.');
					return false;
				}

				const total_values = Array(num_stage_items+1).fill(0);

				function calculateDatatableBonusAmount(row,type,val,meta) {
					if (type === 'type') return 0;
					return row[meta.col] = Math.ceil(row[meta.col-num_stage_items*2] * row[meta.col-num_stage_items] / 100);
				}

				function calculateDatatableTotalAmount(row,type,val,meta) {
					if (type === 'type') return 0;
					return row[meta.col] = (row[meta.col-num_stage_items*3] + row[meta.col-num_stage_items]);
				}

				function calculateDatatableSum(row,type,val,meta) {
					if (type === 'type') return 0;
					let sum = 0;
					for (let i = 1; i <= num_stage_items; ++i) {
						sum += row[meta.col-i];
					}
					return row[meta.col] = sum;
				}

				function calculateDatatableTotalPerAP(row,type,val,meta) {
					if (type === 'type') return 0;
					return (row[meta.col] = (row[meta.col-(num_stage_items+1)] / row[1])).toFixed(2);
				}

				const event_table_data = data.stage_costs.map((ap_cost,stage_index) => {
					const stage_item_amounts = data.stage_item_amounts[stage_index];
					// TODO reload saved bonus multipliers
					const bonus_multipliers = Array(num_stage_items).fill(0);
					return [
						stage_index+1,
						ap_cost,
						...stage_item_amounts,
						...bonus_multipliers
					];
				});

				const event_data_title = document.getElementById('event_data_title');
				event_data_title.innerText = data.names['en'];
				const event_data_table = document.getElementById('event_data');
				new DataTable(event_data_table, {
					columns: [
						{ title: 'Stage' },
						{ title: 'AP Cost' },
						...data.items.map((item,index) => { return {title: 'Item '+ITEM_NAME_PLACEHOLDERS[index]}; }),
						...data.items.map((item,index) => { return {title: 'Multiplier '+ITEM_NAME_PLACEHOLDERS[index]}; }),
						...data.items.map((item,index) => { return {
							title: 'Bonus ' + ITEM_NAME_PLACEHOLDERS[index],
							data: calculateDatatableBonusAmount
						}; }),
						...data.items.map((item,index) => { return {
							title: 'Total ' + ITEM_NAME_PLACEHOLDERS[index],
							data: calculateDatatableTotalAmount
						}; }),
						{ title: 'Sum', data: calculateDatatableSum },
						...data.items.map((item,index) => { return {
							title: 'Total '+ITEM_NAME_PLACEHOLDERS[index]+' / AP',
							data: calculateDatatableTotalPerAP
						}; }),
						{ title: 'Total / AP', data: calculateDatatableTotalPerAP }
					],
					data: event_table_data,

					destroy: true,
					info: false,
					paging: false,
					searching: false
				});

				return true;
			}

			document.addEventListener('DOMContentLoaded', event => {
				const events_table = document.getElementById('events');
				events_table.classList.add('hover','stripe');
				const events_table_data = EVENTS.map((e,i) => {
					let row_data = [
						e.names['en'],
						e.releases['jp'],
						e.releases['global'] || ''
					];
					row_data.DT_RowId = 'events_table_row_' + i;
					return row_data;
				});
				new DataTable(events_table, {
					columns: [
						{ title: 'Name' },
						{ title: 'JP Release Date' },
						{ title: 'Global Release Date' }
					],
					data: events_table_data,
					order: {idx: 1, dir: 'asc'},

					info: false,
					paging: false,
					searching: false
				});
				events_table.addEventListener('click', event => {
					try {
						const row = event.target.closest('tr');
						const index = parseInt(row.id.split('_')[3],10);
						loadEventData(index);
					} catch (error) {
						console.error(error);
					}
				});
			});
		</script>
	</head>
	<body>
		<section>
			<h2>Events</h2>
			<table id="events"></table>
		</section>
		<section>
			<h2 id="event_data_title"></h2>
			<table id="event_data"></table>
		</section>
	</body>
</html>
